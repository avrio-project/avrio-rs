# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
orbs: 
  rust: circleci/rust@1.6.0
  aws-s3: circleci/aws-s3@1.0.15

jobs:
  linux-debug:
    docker:
      # replace with your preferred image
      - image: cimg/base:stable
    steps:
      - checkout
      - rust/install:
          version: nightly
      - rust/build
      - persist_to_workspace:
          root: ~/
          paths:
            - project/build
  windows-debug:
    docker:
      # replace with your preferred image
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker:
          version: 19.03.13
          docker_layer_caching: true
      - rust/install:
          version: nightly
      - run: cargo install cross
      - run: cross build --target x86_64-pc-windows-gnu
      - persist_to_workspace:
          root: ~/
          paths:
            - project/build

  deploy-to-s3:
    machine:
      image: circleci/classic:latest
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - aws-s3/sync:
          arguments: |
            --acl public-read \
            --cache-control "max-age=86400"
          aws-secret-access-key: AWS_ACCESS_KEY
          from: build
          to: 's3://avrio-deploy-bucket'
          overwrite: true 

        

workflows:
  example-workflow:
    jobs:
      - linux-debug
      - windows-debug
      - deploy-to-s3:
          requires:
            - linux-debug